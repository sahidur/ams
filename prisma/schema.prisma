// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Deprecated - keeping for backward compatibility during migration
enum Role {
  ADMIN
  HO_USER
  TRAINER
  STUDENT
  BASIC_USER
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

// Module permissions enum
enum PermissionAction {
  READ
  WRITE
  DELETE
  ALL
}

// System modules for permission management
enum SystemModule {
  DASHBOARD
  USERS
  ROLES
  PROJECTS
  COHORTS
  BRANCHES
  BATCHES
  CLASSES
  ATTENDANCE
  FACE_TRAINING
  MODEL_TYPES
  TRAINING_TYPES
  DESIGNATIONS
  EMPLOYMENT_STATUSES
  EMPLOYMENT_TYPES
  DEPARTMENTS
  GEO_ADMIN
  PROFILE
}

// New Role Management System
model UserRole {
  id          String   @id @default(cuid())
  name        String   @unique
  displayName String
  description String?
  isActive    Boolean  @default(true)
  isSystem    Boolean  @default(false) // True for built-in roles (Super Admin, Admin)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  permissions RolePermission[]
  users       User[]
  
  @@map("user_roles")
}

model RolePermission {
  id        String           @id @default(cuid())
  roleId    String
  role      UserRole         @relation(fields: [roleId], references: [id], onDelete: Cascade)
  module    SystemModule
  actions   PermissionAction[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([roleId, module])
  @@map("role_permissions")
}

model User {
  id             String         @id @default(cuid())
  email          String         @unique
  phone          String?        @unique
  whatsappNumber String?        // WhatsApp Number
  pin            String         // Hashed PIN
  password       String         // Hashed password
  name           String
  role           Role           @default(BASIC_USER) // Deprecated - keeping for backward compatibility
  userRoleId     String?        // New role system
  userRole       UserRole?      @relation(fields: [userRoleId], references: [id])
  approvalStatus ApprovalStatus @default(PENDING)
  isVerified     Boolean        @default(false)
  isActive       Boolean        @default(true)  // User account active status
  createdBy      String?        // Admin who created the user (null if self-registered)
  
  // Personal Details
  dateOfBirth    DateTime?
  gender         String?
  address        String?
  profileImage   String?
  
  // Job Information
  designation           String?         // Legacy field - keeping for backward compatibility
  designationId         String?
  designationRef        Designation?    @relation(fields: [designationId], references: [id])
  department            String?         // Legacy field - keeping for backward compatibility
  departmentId          String?
  departmentRef         Department?     @relation(fields: [departmentId], references: [id])
  joiningDate           DateTime?
  employeeId            String?
  joiningDateBrac       DateTime?       // Joining Date in BRAC
  joiningDateCurrentBase DateTime?      // Joining Date (Current Base)
  joiningDateCurrentPosition DateTime?  // Joining Date (Current Position)
  contractEndDate       DateTime?       // Contract End Date
  employmentStatusId    String?
  employmentStatus      EmploymentStatus? @relation(fields: [employmentStatusId], references: [id])
  employmentTypeId      String?
  employmentType        EmploymentType?   @relation(fields: [employmentTypeId], references: [id])
  firstSupervisorId     String?
  firstSupervisor       User?           @relation("FirstSupervisor", fields: [firstSupervisorId], references: [id])
  subordinates          User[]          @relation("FirstSupervisor")
  jobGrade              Int?            // 1-13
  yearsOfExperience     Float?
  salary                Float?
  
  // Performance Information
  slab                  Int?
  lastSlabChange        DateTime?
  secondLastSlabChange  DateTime?
  lastGradeChange       DateTime?
  secondLastGradeChange DateTime?
  lastOneOffBonus       DateTime?
  secondLastOneOffBonus DateTime?
  pmsMarkLastYear       String?
  pmsMarkSecondLastYear String?
  pmsMarkThirdLastYear  String?
  lastWarningDate       DateTime?
  secondLastWarningDate DateTime?
  thirdLastWarningDate  DateTime?
  
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  
  // Relations
  trainerBatches    Batch[]        @relation("BatchTrainer")
  studentBatches    BatchStudent[]
  studentClasses    ClassStudent[]
  attendances       Attendance[]
  faceEncodings     FaceEncoding[]
  fingerprintCredentials FingerprintCredential[]
  classes           Class[]        @relation("ClassCreator")
  focalProjects     Project[]      @relation("ProjectFocalPerson")
  focalCohorts      Cohort[]       @relation("CohortFocalPerson")
  projectAssignments UserProjectAssignment[]
  branchAssignments  UserBranchAssignment[]
  receivedComments   AdminComment[]  @relation("UserComments")
  writtenComments    AdminComment[]  @relation("CommentAuthor")
  activityLogs       UserActivityLog[] @relation("UserActivityLogs")
  editedActivityLogs UserActivityLog[] @relation("UserActivityEditor")
  
  // Created/Updated by relations
  createdProjects    Project[]      @relation("ProjectCreatedBy")
  updatedProjects    Project[]      @relation("ProjectUpdatedBy")
  createdCohorts     Cohort[]       @relation("CohortCreatedBy")
  updatedCohorts     Cohort[]       @relation("CohortUpdatedBy")
  createdBranches    Branch[]       @relation("BranchCreatedBy")
  updatedBranches    Branch[]       @relation("BranchUpdatedBy")
  
  @@map("users")
}

model ProjectModelType {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  startDate   DateTime  @default(now())
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Relations
  projects    Project[]
  
  @@map("project_model_types")
}

model TrainingType {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  startDate   DateTime  @default(now())
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Relations
  projects    Project[]
  
  @@map("training_types")
}

model Project {
  id              String   @id @default(cuid())
  name            String
  donorName       String
  startDate       DateTime
  endDate         DateTime
  description     String?
  isActive        Boolean  @default(true)
  focalPersonId   String?
  focalPerson     User?    @relation("ProjectFocalPerson", fields: [focalPersonId], references: [id])
  modelTypeId     String?
  modelType       ProjectModelType? @relation(fields: [modelTypeId], references: [id])
  trainingTypeId  String?
  trainingType    TrainingType?     @relation(fields: [trainingTypeId], references: [id])
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdById     String?
  createdBy       User?    @relation("ProjectCreatedBy", fields: [createdById], references: [id])
  updatedById     String?
  updatedBy       User?    @relation("ProjectUpdatedBy", fields: [updatedById], references: [id])
  
  // Relations
  cohorts         Cohort[]
  userAssignments UserProjectAssignment[]
  branchAssignments UserBranchAssignment[] @relation("ProjectBranchAssignments")
  
  @@map("projects")
}

model Cohort {
  id                    String   @id @default(cuid())
  cohortId              String   @unique  // User-defined cohort ID
  name                  String
  projectId             String
  project               Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  duration              Int?     // Duration in months
  learnerTarget         Int?     // Target number of learners
  jobPlacementTarget    Int?     // Target number of job placements
  
  startDate             DateTime?
  endDate               DateTime?
  isActive              Boolean  @default(true)
  description           String?
  focalPersonId         String?
  focalPerson           User?    @relation("CohortFocalPerson", fields: [focalPersonId], references: [id])
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  createdById           String?
  createdBy             User?    @relation("CohortCreatedBy", fields: [createdById], references: [id])
  updatedById           String?
  updatedBy             User?    @relation("CohortUpdatedBy", fields: [updatedById], references: [id])
  
  // Relations
  cohortBranches        CohortBranch[]  // Legacy many-to-many
  directBranches        Branch[]        @relation("CohortBranches")  // Direct branches
  batches               Batch[]
  classes               Class[]
  userAssignments       UserProjectAssignment[]
  branchAssignments     UserBranchAssignment[] @relation("CohortBranchAssignments")
  
  @@map("cohorts")
}

model Branch {
  id          String   @id @default(cuid())
  division    String
  district    String
  upazila     String
  union       String?
  branchName  String
  branchCode  String?  @unique
  isActive    Boolean  @default(true)
  
  // Direct cohort relationship (each branch belongs to one cohort)
  cohortId    String?
  cohort      Cohort?  @relation("CohortBranches", fields: [cohortId], references: [id], onDelete: SetNull)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String?
  createdBy   User?    @relation("BranchCreatedBy", fields: [createdById], references: [id])
  updatedById String?
  updatedBy   User?    @relation("BranchUpdatedBy", fields: [updatedById], references: [id])
  
  // Relations
  cohorts     CohortBranch[]  // Legacy many-to-many relationship
  batches     Batch[]
  userBranchAssignments UserBranchAssignment[]
  
  @@unique([division, district, upazila, branchName])
  @@map("branches")
}

model CohortBranch {
  id        String @id @default(cuid())
  cohortId  String
  branchId  String
  cohort    Cohort @relation(fields: [cohortId], references: [id], onDelete: Cascade)
  branch    Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)
  
  @@unique([cohortId, branchId])
  @@map("cohort_branches")
}

model Batch {
  id          String   @id @default(cuid())
  name        String
  cohortId    String?
  cohort      Cohort?  @relation(fields: [cohortId], references: [id], onDelete: Cascade)
  branchId    String
  branch      Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)
  trainerId   String?
  trainer     User?    @relation("BatchTrainer", fields: [trainerId], references: [id])
  
  startDate   DateTime?
  endDate     DateTime?
  maxStudents Int      @default(30)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  students    BatchStudent[] // Deprecated - keeping for backward compatibility
  classes     Class[]
  
  @@map("batches")
}

model BatchStudent {
  id        String   @id @default(cuid())
  batchId   String
  batch     Batch    @relation(fields: [batchId], references: [id], onDelete: Cascade)
  studentId String
  student   User     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  enrolledAt DateTime @default(now())
  
  @@unique([batchId, studentId])
  @@map("batch_students")
}

model Class {
  id          String   @id @default(cuid())
  name        String
  subject     String
  batchId     String
  batch       Batch    @relation(fields: [batchId], references: [id], onDelete: Cascade)
  cohortId    String?
  cohort      Cohort?  @relation(fields: [cohortId], references: [id], onDelete: Cascade)
  createdById String?
  createdBy   User?    @relation("ClassCreator", fields: [createdById], references: [id])
  
  startDate   DateTime
  endDate     DateTime
  startTime   String   // HH:mm format
  endTime     String   // HH:mm format
  
  description String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  attendances Attendance[]
  students    ClassStudent[]
  
  @@map("classes")
}

// New: Students are assigned to classes, not batches
model ClassStudent {
  id        String   @id @default(cuid())
  classId   String
  class     Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  studentId String
  student   User     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  enrolledAt DateTime @default(now())
  
  @@unique([classId, studentId])
  @@map("class_students")
}

model Attendance {
  id              String   @id @default(cuid())
  classId         String
  class           Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  studentId       String
  student         User     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  isPresent       Boolean  @default(false)
  markedAt        DateTime @default(now())
  markedBy        String   // "FACE_RECOGNITION", "FINGERPRINT" or trainer ID
  confidence      Float?   // Face recognition confidence score
  verificationMethod String? // "FACE", "FINGERPRINT", "MANUAL"
  capturedImageUrl String?  // URL of the captured face image during attendance
  
  // Session ID for multiple attendance per day
  sessionId       String?  // To group attendance by session
  sessionDate     DateTime @default(now()) // Date for the session
  
  // Multiple check-ins during class
  checkIns        DateTime[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Allow multiple attendance per class per student (for different sessions)
  @@index([classId, studentId, sessionId])
  @@map("attendances")
}

model FaceEncoding {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  encoding    Json     // face-api.js face descriptor (128-dimensional array)
  label       String   // Label for the face
  imageUrl    String?  // Original training image URL
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("face_encodings")
}

// WebAuthn/Fingerprint credentials for biometric authentication
model FingerprintCredential {
  id                    String   @id @default(cuid())
  userId                String
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  credentialId          String   @unique // WebAuthn credential ID (base64)
  publicKey             String   // Public key (base64)
  counter               Int      @default(0) // Signature counter
  transports            String[] // Allowed transports (internal, usb, ble, nfc)
  deviceType            String?  // Device type (platform, cross-platform)
  backedUp              Boolean  @default(false)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  @@map("fingerprint_credentials")
}

// User Project and Cohort Assignments
model UserProjectAssignment {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  cohortId    String
  cohort      Cohort   @relation(fields: [cohortId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([userId, projectId, cohortId])
  @@map("user_project_assignments")
}

// User Branch Assignments (multiple branches per user per project/cohort)
model UserBranchAssignment {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  projectId   String
  project     Project  @relation("ProjectBranchAssignments", fields: [projectId], references: [id], onDelete: Cascade)
  cohortId    String
  cohort      Cohort   @relation("CohortBranchAssignments", fields: [cohortId], references: [id], onDelete: Cascade)
  branchId    String
  branch      Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([userId, projectId, cohortId, branchId])
  @@map("user_branch_assignments")
}

model AdminComment {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation("UserComments", fields: [userId], references: [id], onDelete: Cascade)
  authorId    String
  author      User     @relation("CommentAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  comment     String
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  attachments CommentAttachment[]
  
  @@map("admin_comments")
}

model CommentAttachment {
  id          String   @id @default(cuid())
  commentId   String
  comment     AdminComment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  fileName    String
  fileUrl     String
  fileType    String   // mime type
  fileSize    Int      // size in bytes
  
  createdAt   DateTime @default(now())
  
  @@map("comment_attachments")
}

// User Activity Log - tracks all user data changes
model UserActivityLog {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation("UserActivityLogs", fields: [userId], references: [id], onDelete: Cascade)
  editorId    String
  editor      User     @relation("UserActivityEditor", fields: [editorId], references: [id], onDelete: Cascade)
  
  action      String   // CREATE, UPDATE, DELETE
  category    String   // PERSONAL, JOB, BRANCH_ASSIGNMENT, PROJECT_ASSIGNMENT
  field       String?  // Field name that was changed
  oldValue    String?  // Previous value (JSON stringified if complex)
  newValue    String?  // New value (JSON stringified if complex)
  description String?  // Human-readable description of the change
  
  createdAt   DateTime @default(now())
  
  @@index([userId, createdAt])
  @@index([editorId])
  @@map("user_activity_logs")
}

model Designation {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  users       User[]
  
  @@map("designations")
}

model EmploymentStatus {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  users       User[]
  
  @@map("employment_statuses")
}

model EmploymentType {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  users       User[]
  
  @@map("employment_types")
}

model Department {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  users       User[]
  
  @@map("departments")
}

// Bangladesh Geo-Location Models
model Division {
  id          String   @id @default(cuid())
  geoId       String   @unique  // Original ID from geo data
  name        String   @unique
  bnName      String?  // Bengali name
  url         String?
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  districts   District[]
  
  @@map("divisions")
}

model District {
  id          String   @id @default(cuid())
  geoId       String   @unique  // Original ID from geo data
  divisionId  String
  division    Division @relation(fields: [divisionId], references: [id], onDelete: Cascade)
  name        String
  bnName      String?  // Bengali name
  lat         String?
  lon         String?
  url         String?
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  upazilas    Upazila[]
  
  @@unique([divisionId, name])
  @@map("districts")
}

model Upazila {
  id          String   @id @default(cuid())
  geoId       String   @unique  // Original ID from geo data
  districtId  String
  district    District @relation(fields: [districtId], references: [id], onDelete: Cascade)
  name        String
  bnName      String?  // Bengali name
  url         String?
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  unions      Union[]
  
  @@unique([districtId, name])
  @@map("upazilas")
}

model Union {
  id          String   @id @default(cuid())
  geoId       String   @unique  // Original ID from geo data
  upazilaId   String
  upazila     Upazila  @relation(fields: [upazilaId], references: [id], onDelete: Cascade)
  name        String
  bnName      String?  // Bengali name
  url         String?
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([upazilaId, name])
  @@map("unions")
}
