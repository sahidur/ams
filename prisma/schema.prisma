// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Deprecated - keeping for backward compatibility during migration
enum Role {
  ADMIN
  HO_USER
  TRAINER
  STUDENT
  BASIC_USER
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

// Module permissions enum
enum PermissionAction {
  READ
  WRITE
  DELETE
  ALL
}

// System modules for permission management
enum SystemModule {
  DASHBOARD
  USERS
  ROLES
  PROJECTS
  COHORTS
  BRANCHES
  BATCHES
  CLASSES
  ATTENDANCE
  FACE_TRAINING
  MODEL_TYPES
  TRAINING_TYPES
  DESIGNATIONS
  EMPLOYMENT_STATUSES
  EMPLOYMENT_TYPES
  DEPARTMENTS
  GEO_ADMIN
  PROFILE
  APPROVALS
  APPROVAL_TEMPLATES
}

// New Role Management System
model UserRole {
  id          String   @id @default(cuid())
  name        String   @unique
  displayName String
  description String?
  isActive    Boolean  @default(true)
  isSystem    Boolean  @default(false) // True for built-in roles (Super Admin, Admin)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  permissions RolePermission[]
  users       User[]
  approverLevels ApprovalLevelApprover[]
  
  @@map("user_roles")
}

model RolePermission {
  id        String           @id @default(cuid())
  roleId    String
  role      UserRole         @relation(fields: [roleId], references: [id], onDelete: Cascade)
  module    SystemModule
  actions   PermissionAction[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([roleId, module])
  @@map("role_permissions")
}

model User {
  id             String         @id @default(cuid())
  email          String         @unique
  phone          String?        @unique
  whatsappNumber String?        // WhatsApp Number
  pin            String         // Hashed PIN
  password       String         // Hashed password
  name           String
  role           Role           @default(BASIC_USER) // Deprecated - keeping for backward compatibility
  userRoleId     String?        // New role system
  userRole       UserRole?      @relation(fields: [userRoleId], references: [id])
  approvalStatus ApprovalStatus @default(PENDING)
  isVerified     Boolean        @default(false)
  isActive       Boolean        @default(true)  // User account active status
  createdBy      String?        // Admin who created the user (null if self-registered)
  
  // Personal Details
  dateOfBirth    DateTime?
  gender         String?
  address        String?
  profileImage   String?
  
  // Job Information
  designation           String?         // Legacy field - keeping for backward compatibility
  designationId         String?
  designationRef        Designation?    @relation(fields: [designationId], references: [id])
  department            String?         // Legacy field - keeping for backward compatibility
  departmentId          String?
  departmentRef         Department?     @relation(fields: [departmentId], references: [id])
  joiningDate           DateTime?
  employeeId            String?
  joiningDateBrac       DateTime?       // Joining Date in BRAC
  joiningDateCurrentBase DateTime?      // Joining Date (Current Base)
  joiningDateCurrentPosition DateTime?  // Joining Date (Current Position)
  contractEndDate       DateTime?       // Contract End Date
  employmentStatusId    String?
  employmentStatus      EmploymentStatus? @relation(fields: [employmentStatusId], references: [id])
  employmentTypeId      String?
  employmentType        EmploymentType?   @relation(fields: [employmentTypeId], references: [id])
  firstSupervisorId     String?
  firstSupervisor       User?           @relation("FirstSupervisor", fields: [firstSupervisorId], references: [id])
  subordinates          User[]          @relation("FirstSupervisor")
  jobGrade              Int?            // 1-13
  yearsOfExperience     Float?
  salary                Float?
  
  // Performance Information
  slab                  Int?
  lastSlabChange        DateTime?
  secondLastSlabChange  DateTime?
  lastGradeChange       DateTime?
  secondLastGradeChange DateTime?
  lastOneOffBonus       DateTime?
  secondLastOneOffBonus DateTime?
  pmsMarkLastYear       String?
  pmsMarkSecondLastYear String?
  pmsMarkThirdLastYear  String?
  lastWarningDate       DateTime?
  secondLastWarningDate DateTime?
  thirdLastWarningDate  DateTime?
  
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  
  // Relations
  trainerBatches    Batch[]        @relation("BatchTrainer")
  studentBatches    BatchStudent[]
  studentClasses    ClassStudent[]
  attendances       Attendance[]
  faceEncodings     FaceEncoding[]
  fingerprintCredentials FingerprintCredential[]
  classes           Class[]        @relation("ClassCreator")
  focalProjects     Project[]      @relation("ProjectFocalPerson")
  focalCohorts      Cohort[]       @relation("CohortFocalPerson")
  projectAssignments UserProjectAssignment[]
  branchAssignments  UserBranchAssignment[]
  receivedComments   AdminComment[]  @relation("UserComments")
  writtenComments    AdminComment[]  @relation("CommentAuthor")
  activityLogs       UserActivityLog[] @relation("UserActivityLogs")
  editedActivityLogs UserActivityLog[] @relation("UserActivityEditor")
  passkeys           UserPasskey[]
  
  // Created/Updated by relations
  createdProjects    Project[]      @relation("ProjectCreatedBy")
  updatedProjects    Project[]      @relation("ProjectUpdatedBy")
  createdCohorts     Cohort[]       @relation("CohortCreatedBy")
  updatedCohorts     Cohort[]       @relation("CohortUpdatedBy")
  createdBranches    Branch[]       @relation("BranchCreatedBy")
  updatedBranches    Branch[]       @relation("BranchUpdatedBy")
  
  // Approval System Relations
  createdTemplates     ApprovalTemplate[]  @relation("TemplateCreator")
  escalationLevels     ApprovalLevel[]     @relation("EscalationUser")
  approverLevels       ApprovalLevelApprover[] @relation("LevelApprover")
  submittedRequests    ApprovalRequest[]   @relation("RequestSubmitter")
  pendingApprovals     ApprovalRequest[]   @relation("CurrentApprover")
  approvalActions      ApprovalAction[]    @relation("ActionActor")
  notifications        Notification[]
  
  // Login Logs
  loginLogs            LoginLog[]
  
  @@map("users")
}

// Login Log Model for tracking user login activity
enum LoginMethod {
  PASSWORD
  PASSKEY
  PIN
}

model LoginLog {
  id          String      @id @default(cuid())
  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Login details
  method      LoginMethod
  success     Boolean     @default(true)
  failReason  String?     // Reason for failed login attempt
  
  // Device and location info
  ipAddress   String?
  userAgent   String?
  deviceType  String?     // mobile, tablet, desktop
  browser     String?
  os          String?
  country     String?
  city        String?
  
  createdAt   DateTime    @default(now())
  
  @@index([userId])
  @@index([createdAt])
  @@map("login_logs")
}

model ProjectModelType {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  startDate   DateTime  @default(now())
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Relations
  projects    Project[]
  
  @@map("project_model_types")
}

model TrainingType {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  startDate   DateTime  @default(now())
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Relations
  projects    Project[]
  
  @@map("training_types")
}

model Project {
  id              String   @id @default(cuid())
  name            String
  donorName       String
  startDate       DateTime
  endDate         DateTime
  description     String?
  isActive        Boolean  @default(true)
  focalPersonId   String?
  focalPerson     User?    @relation("ProjectFocalPerson", fields: [focalPersonId], references: [id])
  modelTypeId     String?
  modelType       ProjectModelType? @relation(fields: [modelTypeId], references: [id])
  trainingTypeId  String?
  trainingType    TrainingType?     @relation(fields: [trainingTypeId], references: [id])
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdById     String?
  createdBy       User?    @relation("ProjectCreatedBy", fields: [createdById], references: [id])
  updatedById     String?
  updatedBy       User?    @relation("ProjectUpdatedBy", fields: [updatedById], references: [id])
  
  // Relations
  cohorts         Cohort[]
  userAssignments UserProjectAssignment[]
  branchAssignments UserBranchAssignment[] @relation("ProjectBranchAssignments")
  approvalLevels  ApprovalLevel[]
  approvalRequests ApprovalRequest[]
  
  @@map("projects")
}

model Cohort {
  id                    String   @id @default(cuid())
  cohortId              String   @unique  // User-defined cohort ID
  name                  String
  projectId             String
  project               Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  duration              Int?     // Duration in months
  learnerTarget         Int?     // Target number of learners
  jobPlacementTarget    Int?     // Target number of job placements
  
  startDate             DateTime?
  endDate               DateTime?
  isActive              Boolean  @default(true)
  description           String?
  focalPersonId         String?
  focalPerson           User?    @relation("CohortFocalPerson", fields: [focalPersonId], references: [id])
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  createdById           String?
  createdBy             User?    @relation("CohortCreatedBy", fields: [createdById], references: [id])
  updatedById           String?
  updatedBy             User?    @relation("CohortUpdatedBy", fields: [updatedById], references: [id])
  
  // Relations
  cohortBranches        CohortBranch[]  // Legacy many-to-many
  directBranches        Branch[]        @relation("CohortBranches")  // Direct branches
  batches               Batch[]
  classes               Class[]
  userAssignments       UserProjectAssignment[]
  branchAssignments     UserBranchAssignment[] @relation("CohortBranchAssignments")
  approvalLevels        ApprovalLevel[]
  approvalRequests      ApprovalRequest[]
  
  @@map("cohorts")
}

model Branch {
  id          String   @id @default(cuid())
  division    String
  district    String
  upazila     String
  union       String?
  branchName  String
  branchCode  String?  @unique
  isActive    Boolean  @default(true)
  
  // Direct cohort relationship (each branch belongs to one cohort)
  cohortId    String?
  cohort      Cohort?  @relation("CohortBranches", fields: [cohortId], references: [id], onDelete: SetNull)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String?
  createdBy   User?    @relation("BranchCreatedBy", fields: [createdById], references: [id])
  updatedById String?
  updatedBy   User?    @relation("BranchUpdatedBy", fields: [updatedById], references: [id])
  
  // Relations
  cohorts     CohortBranch[]  // Legacy many-to-many relationship
  batches     Batch[]
  userBranchAssignments UserBranchAssignment[]
  approvalRequests      ApprovalRequest[]
  
  @@unique([division, district, upazila, branchName])
  @@map("branches")
}

model CohortBranch {
  id        String @id @default(cuid())
  cohortId  String
  branchId  String
  cohort    Cohort @relation(fields: [cohortId], references: [id], onDelete: Cascade)
  branch    Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)
  
  @@unique([cohortId, branchId])
  @@map("cohort_branches")
}

model Batch {
  id          String   @id @default(cuid())
  name        String
  cohortId    String?
  cohort      Cohort?  @relation(fields: [cohortId], references: [id], onDelete: Cascade)
  branchId    String
  branch      Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)
  trainerId   String?
  trainer     User?    @relation("BatchTrainer", fields: [trainerId], references: [id])
  
  startDate   DateTime?
  endDate     DateTime?
  maxStudents Int      @default(30)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  students    BatchStudent[] // Deprecated - keeping for backward compatibility
  classes     Class[]
  
  @@map("batches")
}

model BatchStudent {
  id        String   @id @default(cuid())
  batchId   String
  batch     Batch    @relation(fields: [batchId], references: [id], onDelete: Cascade)
  studentId String
  student   User     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  enrolledAt DateTime @default(now())
  
  @@unique([batchId, studentId])
  @@map("batch_students")
}

model Class {
  id          String   @id @default(cuid())
  name        String
  subject     String
  batchId     String
  batch       Batch    @relation(fields: [batchId], references: [id], onDelete: Cascade)
  cohortId    String?
  cohort      Cohort?  @relation(fields: [cohortId], references: [id], onDelete: Cascade)
  createdById String?
  createdBy   User?    @relation("ClassCreator", fields: [createdById], references: [id])
  
  startDate   DateTime
  endDate     DateTime
  startTime   String   // HH:mm format
  endTime     String   // HH:mm format
  
  description String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  attendances Attendance[]
  students    ClassStudent[]
  
  @@map("classes")
}

// New: Students are assigned to classes, not batches
model ClassStudent {
  id        String   @id @default(cuid())
  classId   String
  class     Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  studentId String
  student   User     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  enrolledAt DateTime @default(now())
  
  @@unique([classId, studentId])
  @@map("class_students")
}

model Attendance {
  id              String   @id @default(cuid())
  classId         String
  class           Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  studentId       String
  student         User     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  isPresent       Boolean  @default(false)
  markedAt        DateTime @default(now())
  markedBy        String   // "FACE_RECOGNITION", "FINGERPRINT" or trainer ID
  confidence      Float?   // Face recognition confidence score
  verificationMethod String? // "FACE", "FINGERPRINT", "MANUAL"
  capturedImageUrl String?  // URL of the captured face image during attendance
  
  // Session ID for multiple attendance per day
  sessionId       String?  // To group attendance by session
  sessionDate     DateTime @default(now()) // Date for the session
  
  // Multiple check-ins during class
  checkIns        DateTime[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Allow multiple attendance per class per student (for different sessions)
  @@index([classId, studentId, sessionId])
  @@map("attendances")
}

model FaceEncoding {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  encoding    Json     // Encrypted face embedding data
  label       String   // Label for the face
  imageUrl    String?  // Original training image URL
  
  // Encryption fields for secure storage
  encryptionIv    String?  // Initialization vector for AES-256-GCM
  encryptionTag   String?  // Authentication tag for AES-256-GCM
  salt            String?  // Salt used for hashing
  embeddingHash   String?  // SHA-256 hash for integrity verification
  
  // Consent tracking
  consentGiven    Boolean  @default(false)
  consentDate     DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("face_encodings")
}

// WebAuthn/Fingerprint credentials for biometric authentication
model FingerprintCredential {
  id                    String   @id @default(cuid())
  userId                String
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  credentialId          String   @unique // WebAuthn credential ID (base64)
  publicKey             String   // Public key (base64)
  counter               Int      @default(0) // Signature counter
  transports            String[] // Allowed transports (internal, usb, ble, nfc)
  deviceType            String?  // Device type (platform, cross-platform)
  backedUp              Boolean  @default(false)
  
  // Encryption fields
  credentialIdHash      String?  // SHA-256 hash of credential ID
  
  // Consent tracking
  consentGiven          Boolean  @default(false)
  consentDate           DateTime?
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  @@map("fingerprint_credentials")
}

// User Passkeys for passwordless login
model UserPasskey {
  id                    String   @id @default(cuid())
  userId                String
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  credentialId          String   @unique // WebAuthn credential ID (base64)
  publicKey             String   // Public key (base64)
  counter               Int      @default(0) // Signature counter
  
  // Consent tracking
  consentGiven          Boolean  @default(false)
  consentDate           DateTime?
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  @@map("user_passkeys")
}

// User Project and Cohort Assignments
model UserProjectAssignment {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  cohortId    String
  cohort      Cohort   @relation(fields: [cohortId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([userId, projectId, cohortId])
  @@map("user_project_assignments")
}

// User Branch Assignments (multiple branches per user per project/cohort)
model UserBranchAssignment {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  projectId   String
  project     Project  @relation("ProjectBranchAssignments", fields: [projectId], references: [id], onDelete: Cascade)
  cohortId    String
  cohort      Cohort   @relation("CohortBranchAssignments", fields: [cohortId], references: [id], onDelete: Cascade)
  branchId    String
  branch      Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([userId, projectId, cohortId, branchId])
  @@map("user_branch_assignments")
}

model AdminComment {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation("UserComments", fields: [userId], references: [id], onDelete: Cascade)
  authorId    String
  author      User     @relation("CommentAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  comment     String
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  attachments CommentAttachment[]
  
  @@map("admin_comments")
}

model CommentAttachment {
  id          String   @id @default(cuid())
  commentId   String
  comment     AdminComment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  fileName    String
  fileUrl     String
  fileType    String   // mime type
  fileSize    Int      // size in bytes
  
  createdAt   DateTime @default(now())
  
  @@map("comment_attachments")
}

// User Activity Log - tracks all user data changes
model UserActivityLog {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation("UserActivityLogs", fields: [userId], references: [id], onDelete: Cascade)
  editorId    String
  editor      User     @relation("UserActivityEditor", fields: [editorId], references: [id], onDelete: Cascade)
  
  action      String   // CREATE, UPDATE, DELETE
  category    String   // PERSONAL, JOB, BRANCH_ASSIGNMENT, PROJECT_ASSIGNMENT
  field       String?  // Field name that was changed
  oldValue    String?  // Previous value (JSON stringified if complex)
  newValue    String?  // New value (JSON stringified if complex)
  description String?  // Human-readable description of the change
  
  createdAt   DateTime @default(now())
  
  @@index([userId, createdAt])
  @@index([editorId])
  @@map("user_activity_logs")
}

model Designation {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  users       User[]
  
  @@map("designations")
}

model EmploymentStatus {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  users       User[]
  
  @@map("employment_statuses")
}

model EmploymentType {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  users       User[]
  
  @@map("employment_types")
}

model Department {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  users       User[]
  
  @@map("departments")
}

// Bangladesh Geo-Location Models
model Division {
  id          String   @id @default(cuid())
  geoId       String   @unique  // Original ID from geo data
  name        String   @unique
  bnName      String?  // Bengali name
  url         String?
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  districts   District[]
  
  @@map("divisions")
}

model District {
  id          String   @id @default(cuid())
  geoId       String   @unique  // Original ID from geo data
  divisionId  String
  division    Division @relation(fields: [divisionId], references: [id], onDelete: Cascade)
  name        String
  bnName      String?  // Bengali name
  lat         String?
  lon         String?
  url         String?
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  upazilas    Upazila[]
  
  @@unique([divisionId, name])
  @@map("districts")
}

model Upazila {
  id          String   @id @default(cuid())
  geoId       String   @unique  // Original ID from geo data
  districtId  String
  district    District @relation(fields: [districtId], references: [id], onDelete: Cascade)
  name        String
  bnName      String?  // Bengali name
  url         String?
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  unions      Union[]
  
  @@unique([districtId, name])
  @@map("upazilas")
}

model Union {
  id          String   @id @default(cuid())
  geoId       String   @unique  // Original ID from geo data
  upazilaId   String
  upazila     Upazila  @relation(fields: [upazilaId], references: [id], onDelete: Cascade)
  name        String
  bnName      String?  // Bengali name
  url         String?
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([upazilaId, name])
  @@map("unions")
}

// ==========================================
// APPROVAL MANAGEMENT SYSTEM
// ==========================================

// Approval Request Status
enum ApprovalRequestStatus {
  DRAFT
  PENDING
  APPROVED
  DECLINED
  SENT_BACK
  CANCELLED
}

// Approval Action Type
enum ApprovalActionType {
  SUBMIT
  APPROVE
  DECLINE
  SEND_BACK
  CANCEL
  RESUBMIT
}

// Notification Type
enum NotificationType {
  APPROVAL_ASSIGNED
  APPROVAL_APPROVED
  APPROVAL_DECLINED
  APPROVAL_SENT_BACK
  APPROVAL_FINAL
  APPROVAL_RESUBMITTED
  SYSTEM
}

// Application Type / Approval Template
model ApprovalTemplate {
  id             String   @id @default(cuid())
  name           String   @unique
  displayName    String
  description    String?
  icon           String?  // Icon name for UI
  color          String?  // Color code for UI
  isActive       Boolean  @default(true)
  
  // SLA Configuration
  defaultSlaHours Int?    // Default SLA hours per level
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  createdById    String?
  createdBy      User?    @relation("TemplateCreator", fields: [createdById], references: [id])
  
  // Relations
  formFields     ApprovalFormField[]
  levels         ApprovalLevel[]
  requests       ApprovalRequest[]
  
  @@map("approval_templates")
}

// Dynamic Form Fields for each Application Type
model ApprovalFormField {
  id             String   @id @default(cuid())
  templateId     String
  template       ApprovalTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  
  fieldName      String   // Internal name
  fieldLabel     String   // Display label
  fieldType      String   // text, textarea, number, date, select, file, checkbox, radio
  placeholder    String?
  helpText       String?
  isRequired     Boolean  @default(false)
  options        String[] // For select/radio/checkbox - JSON array of options
  validation     String?  // JSON validation rules
  defaultValue   String?
  sortOrder      Int      @default(0)
  isActive       Boolean  @default(true)
  
  // Conditional display
  dependsOnField String?  // Field name this depends on
  dependsOnValue String?  // Value that triggers display
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  @@unique([templateId, fieldName])
  @@map("approval_form_fields")
}

// Approval Levels per Template (can be project/cohort specific)
model ApprovalLevel {
  id             String   @id @default(cuid())
  templateId     String
  template       ApprovalTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  
  levelNumber    Int      // 1, 2, 3... (sequential)
  levelName      String   // e.g., "Immediate Supervisor", "Branch Manager"
  
  // Scope - if null, applies globally; otherwise project/cohort specific
  projectId      String?
  project        Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  cohortId       String?
  cohort         Cohort?  @relation(fields: [cohortId], references: [id], onDelete: Cascade)
  
  // SLA for this level (overrides template default)
  slaHours       Int?
  
  // Escalation settings
  escalateAfterHours Int?
  escalateToUserId   String?
  escalateTo         User?    @relation("EscalationUser", fields: [escalateToUserId], references: [id])
  
  isActive       Boolean  @default(true)
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  // Relations
  approvers      ApprovalLevelApprover[]
  
  @@unique([templateId, levelNumber, projectId, cohortId])
  @@map("approval_levels")
}

// Approvers assigned to each level
model ApprovalLevelApprover {
  id             String   @id @default(cuid())
  levelId        String
  level          ApprovalLevel @relation(fields: [levelId], references: [id], onDelete: Cascade)
  
  // Can be a specific user or a role
  userId         String?
  user           User?    @relation("LevelApprover", fields: [userId], references: [id])
  userRoleId     String?
  userRole       UserRole? @relation(fields: [userRoleId], references: [id])
  
  // If role-based, can be relative to requester
  isRequesterSupervisor Boolean @default(false) // Use requester's firstSupervisor
  
  sortOrder      Int      @default(0) // For multiple approvers at same level
  isActive       Boolean  @default(true)
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  @@map("approval_level_approvers")
}

// Approval Request (submitted by user)
model ApprovalRequest {
  id             String   @id @default(cuid())
  requestNumber  String   @unique // Auto-generated reference number
  
  templateId     String
  template       ApprovalTemplate @relation(fields: [templateId], references: [id])
  
  // Requester
  requesterId    String
  requester      User     @relation("RequestSubmitter", fields: [requesterId], references: [id])
  
  // Context
  projectId      String?
  project        Project? @relation(fields: [projectId], references: [id])
  cohortId       String?
  cohort         Cohort?  @relation(fields: [cohortId], references: [id])
  branchId       String?
  branch         Branch?  @relation(fields: [branchId], references: [id])
  
  // Form data stored as JSON
  formData       Json
  
  // Attachments
  attachments    String[] // URLs of uploaded files
  
  // Status tracking
  status         ApprovalRequestStatus @default(DRAFT)
  currentLevel   Int      @default(0) // 0 = not started, 1 = first level, etc.
  totalLevels    Int      @default(0)
  
  // Current approver(s)
  currentApproverId String?
  currentApprover   User?    @relation("CurrentApprover", fields: [currentApproverId], references: [id])
  
  // Timestamps
  submittedAt    DateTime?
  completedAt    DateTime?
  
  // SLA tracking
  slaDeadline    DateTime?
  isOverdue      Boolean  @default(false)
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  // Relations
  actions        ApprovalAction[]
  
  @@index([requesterId, status])
  @@index([currentApproverId, status])
  @@index([status, createdAt])
  @@map("approval_requests")
}

// Approval Action History (immutable audit log)
model ApprovalAction {
  id             String   @id @default(cuid())
  requestId      String
  request        ApprovalRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  
  actionType     ApprovalActionType
  level          Int      // Level at which action was taken
  
  // Actor
  actorId        String
  actor          User     @relation("ActionActor", fields: [actorId], references: [id])
  
  // Comments/Notes
  comment        String?
  
  // Previous/Next approver info for tracking
  previousApproverId String?
  nextApproverId     String?
  
  // Snapshot of form data at this point (for audit)
  formDataSnapshot   Json?
  
  // Timestamps
  createdAt      DateTime @default(now())
  
  // SLA info
  wasOverdue     Boolean  @default(false)
  responseTimeHours Float? // How long it took to respond
  
  @@index([requestId, createdAt])
  @@map("approval_actions")
}

// In-App Notifications
model Notification {
  id             String   @id @default(cuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type           NotificationType
  title          String
  message        String
  
  // Link to related entity
  entityType     String?  // "approval_request", "user", etc.
  entityId       String?
  
  isRead         Boolean  @default(false)
  readAt         DateTime?
  
  createdAt      DateTime @default(now())
  
  @@index([userId, isRead, createdAt])
  @@map("notifications")
}
